---
title: "【AITL】Silicon Pathway Ch4：FSM正しさの形式保証（Invariant等）"
emoji: "🧾"
type: "tech"
topics: ["verilog", "formal", "fsm", "asic", "aitl"]
published: false
---

# Chapter4：動いた／合成できた、の次へ

Chapter1〜3 でやったことは大きく2つです。

- **動いた**：Simulation で想定シナリオを通した  
- **作れる**：合成でき、ASIC flow（概念）も成立した

でも、ここで残る問いがあります。

> 「想定していない入力列」や「到達しうる全状態」に対しても **常に正しい** と言えるのか？

Chapter4 は、FSM の正しさを **形式的・構造的に保証する** ための考え方を整理します。  
（ツール操作は補足扱い。人間がレビューできる形が主役です）

---

# 1. 思想：FSM の正しさをどう定義するか

## 1.1 構造的正しさ（Construction）
設計ルールや構造でバグを潰すやり方です。

- state の定義が有限で、合法状態しか取り得ない
- reset で必ず既知の初期状態へ入る
- 出力が全状態で必ず定義され、暗黙ラッチが入らない
- 遷移の優先順位が明確で、条件が競合しても決まる

構造で潰せるバグは多いです。

## 1.2 性質としての正しさ（Property）
「常に成立するべき条件」を列挙します。

- 不変条件（Invariant）：常に成立
- 安全性（Safety）：「悪いこと」が起きない
- 完全性（Completeness）：「必要なこと」が抜けていない
- 進行性（Progress）：必要なら「いつかここへ到達する」

---

# 2. 定義：Invariant（不変条件）を仕様から作る

Invariant は「仕様の言い換え」です。  
書き方のコツは次の手順です。

1. **境界I/Fを列挙**（入力・出力）
2. **状態の意味を文章化**
3. 意味を **制約（Invariant）へ変換**
4. 依存する **仮定（Assumption）** を明記する

---

## 2.1 Invariant カテゴリ（おすすめ）

- **状態合法性**：state は定義集合のどれか  
- **出力合法性**：禁止出力の組合せが出ない  
- **遷移合法性**：状態ごとの許可遷移集合を超えない  
- **ERROR/SAFE 条件**：fault なしで ERROR へ入らない  
- **復帰条件**：ack なしで復帰しない  
- **進行性（必要なら）**：公平性仮定の下で DONE へ到達

---

# 3. 検証観点：安全性・完全性

## 3.1 安全性（Safety）
- 禁止遷移が発生しない
- 禁止出力が発生しない
- fault が入ったら SAFE/ERROR へ落ちる（仕様どおり）

## 3.2 完全性（Completeness）
- 全状態で、入力カテゴリごとに遷移が定義されている
- fault/abort の「抜け」がない
- 仕様状態が到達可能（到達不能なら理由がある）

**安全だけ**でもダメです（安全だが固まる）。  
**完全だけ**でもダメです（全部遷移できるが危険遷移も通る）。

---

# 4. Python ↔ Verilog の意味的等価性

「同じ」と言うには、どのレベルの等価性か決めます。

- レベル0：I/O トレースが一致  
- レベル1：I/O + 状態（意味写像）が一致（おすすめ）  
- レベル2：相互シミュレーション（bisimulation）

Chapter4 では **レベル1** を基準にします。

必要なもの：
- 抽象化仮定（clk、reset、出力タイミング）
- 状態写像表（Python state ↔ Verilog state）
- 差分が出たときの診断手順（最初にズレたサイクルを追う）

---

# 5. PID / LLM と接続するための保証境界

AITL は三層です。

- PID：内側の実時間ループ（安定性・性能）
- FSM：外側の監督（モード・安全・故障）
- LLM：最外層（診断・再設計）

FSM は **契約（Assume/Guarantee）** を明示すべきです。

## 5.1 FSM が仮定すること（Assume）
- 入力は同期されている
- reset の扱いが規定どおり
- command の符号化が正しい 等

## 5.2 FSM が保証すること（Guarantee）
- 合法状態のみ
- safe_en による制御遮断
- fault 時に SAFE/ERROR へ遷移
- LLM へ状態・故障理由を観測可能に提供 等

LLM が遷移規則を更新するなら、更新は「安全窓」で行い、
再び Invariant チェックを通す（ガード付き更新）が必須です。

---

# 6. Chapter4 の Done 条件（チェックリスト）

- Invariant が仕様から列挙されている
- 安全性：禁止遷移／禁止出力／fault パスが説明できる
- 完全性：状態×入力カテゴリの遷移表が埋まっている
- 等価性：Python↔Verilog の写像と基準が書けている
- 境界：PID/LLM との契約が文章化されている

---

# まとめ

Chapter4 は「formal tool を回した」こと自体が目的ではありません。  
**人間が読める形で正しさを定義し、抜けや逸脱を検出できる枠組み** を作るのが目的です。

次章以降でツール（SVA/モデル検査）へ落とし込むときも、
この Chapter4 の成果物が、そのまま仕様・レビュー・検証の土台になります。
